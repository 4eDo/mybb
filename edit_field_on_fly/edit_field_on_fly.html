<script id="efof">
    const FIELD_ID_FOR_EDIT = "fld1";
    const ADD_CACHE_TEXT = "Изменение баланса";
    const COLOR_INPUT_TEXT = "color: #000000 !important";
    const ALLOWED_TOPICS = ['1']; // С кавычками
    const ALLOWED_GROUPS = [1]; // БЕЗ кавычек

    var currentTopic = $get.id;
    $(document).ready(function() {
    if(!ALLOWED_GROUPS.includes(GroupID) || !ALLOWED_TOPICS.includes(currentTopic)) {
        $('#efof').remove();
    } else {
        console.group("4eDo script edit_field_on_fly ");
        console.log("%c~~ Скрипт для быстрого начисления/списания средств. %c https://github.com/4eDo ~~", "font-weight: bold;", "font-weight: bold;");
        console.groupEnd();
        
        const postRatings = $('.post-rating');
        let inpId = 0;
    
        postRatings.each(function() {
            const postRating = $(this);
            const parentPost = postRating.closest('[data-user-id]');
            const userId = parentPost.data('user-id');
    
            const $newDiv = $('<div></div>');
    
            const $button = $('<input type="button" />')
                .addClass('edit_on_fly button preview')
                .val(ADD_CACHE_TEXT)
                .css('cursor', 'pointer')
                .on('click', function() {
                    $labelType.show();
                });
    
            const $selType = $('<select></select>')
                .attr('id', `select-type-${inpId}`)
                .on('change', function() {
                    $labelCount.toggle($selType.val() !== "0");
                });
    
            $selType.append('<option value="0">Не выбрано</option>')
                .append('<option value="1">начисление</option>')
                .append('<option value="-1">списание</option>');
    
            const $labelType = $('<p>Тип операции: </p>').hide().append($selType);
            const $inputCount = $('<input type="number" min="0" />')
                .attr('style', COLOR_INPUT_TEXT)
                .attr('id', `input-count-${inpId}`)
                .on('input', function() {
                    $buttonGo.toggle($inputCount.val() > 0);
                });
    
            const $labelCount = $('<p>Количество: </p>').hide().append($inputCount);
    
            const $buttonGo = $('<input type="button" />')
                .addClass('edit_on_fly button submit')
                .val("Выполнить")
                .hide()
                .css('cursor', 'pointer')
                .on('click', function() {
                    const action = $selType.val();
                    const count = $inputCount.val();
                    $buttonGo.prop('disabled', true);
                    $labelType.css('opacity', '0.5').css('pointer-events', 'none');
                    $labelCount.css('opacity', '0.5').css('pointer-events', 'none');
                    $buttonGo.css('opacity', '0.5').css('pointer-events', 'none');
                    sendDataThroughIframe(action, count, userId, $inputCount, $buttonGo, $newDiv);
                });
    
            $newDiv.append($button, $labelType, $labelCount, $buttonGo);
            postRating.after($newDiv);
    
            inpId++;
        });
    
    function sendDataThroughIframe(action, count, uid, $inputCount, $buttonGo, $container) {
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
        iframe.src = window.location.origin + '/profile.php?section=fields&id=' + uid;
    
        iframe.onload = function() {
            const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
    
            if (!iframeDocument) {
                const $errorMessage = $('<p class="editOnFly_error">Произошла ошибка.</p>');
                $container.append($errorMessage);
                document.body.removeChild(iframe);
                return;
            }
    
            const targetInput = iframeDocument.querySelector('input[name="form[' + FIELD_ID_FOR_EDIT + ']"]');
            const submitButton = iframeDocument.querySelector('#profile8 > p > input');
    
            if (targetInput) {
                let targetValue = parseInt(targetInput.value) || 0;
                const oldValue = targetValue;
    
                targetValue += action*parseInt(count);
    
                targetInput.value = targetValue;
    
                if (submitButton) {
                    submitButton.click();
    
                    const $successMessage = $(`
                        <table class="editOnFly_success" border="1" style="margin-top: 10px;">
                            <tr>
                                <td>Тип операции:</td>
                                <td>${action > 0 ? 'начисление' : 'списание'}</td>
                            </tr>
                            <tr>
                                <td>Количество:</td>
                                <td>${count}</td>
                            </tr>
                            <tr>
                                <td>Было:</td>
                                <td>${oldValue}</td>
                            </tr>
                            <tr>
                                <td>Стало:</td>
                                <td>${targetValue}</td>
                            </tr>
                        </table>
                        <p>Новые значения будут видны после обновления страницы.</p>
                    `);
                    $container.append($successMessage);
                }
            } else {
                const $errorMessage = $('<p class="editOnFly_error">Произошла ошибка.</p>');
                $container.append($errorMessage);
                document.body.removeChild(iframe);
                return;
            }
    
            iframe.onload = function() {
                document.body.removeChild(iframe);
            };
        };
    
        iframe.onerror = function() {
            const $errorMessage = $('<p class="editOnFly_error">Произошла ошибка.</p>');
            $container.append($errorMessage);
            document.body.removeChild(iframe);
        };
    }
       
    }
    });
    </script>
